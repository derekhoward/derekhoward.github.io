<!DOCTYPE html>
<html lang="en"
>
<head>
    <title>Whole-cell electrophysiology analysis with python - Traces of thought</title>
    <!-- Using the latest rendering mode for IE -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">



<link rel="canonical" href="/posts/2016/05/whole-cell-electrophysiology-analysis-with-python/">

        <meta name="author" content="Derek Howard" />
        <meta name="keywords" content="tutorial,python,neuroscience" />
        <meta name="description" content="This notebook is to demonstrate how I have used Neo and EFEL packages to visualize and analyze whole-cell electrophysiology data. This was one of the first scientific problems that showed me how python could speed up my required analysis for my research project. import efel import numpy as np import ..." />

        <meta property="og:site_name" content="Traces of thought" />
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Whole-cell electrophysiology analysis with python"/>
        <meta property="og:url" content="/posts/2016/05/whole-cell-electrophysiology-analysis-with-python/"/>
        <meta property="og:description" content="This notebook is to demonstrate how I have used Neo and EFEL packages to visualize and analyze whole-cell electrophysiology data. This was one of the first scientific problems that showed me how python could speed up my required analysis for my research project. import efel import numpy as np import ..."/>
        <meta property="article:published_time" content="2016-05-04" />
            <meta property="article:section" content="misc" />
            <meta property="article:tag" content="tutorial" />
            <meta property="article:tag" content="python" />
            <meta property="article:tag" content="neuroscience" />
            <meta property="article:author" content="Derek Howard" />


    <!-- Bootstrap -->
        <link rel="stylesheet" href="/theme/css/bootstrap.simplex.min.css" type="text/css"/>
    <link href="/theme/css/font-awesome.min.css" rel="stylesheet">

    <link href="/theme/css/pygments/native.css" rel="stylesheet">
    <link rel="stylesheet" href="/theme/css/style.css" type="text/css"/>


</head>
<body>

<div class="navbar navbar-default navbar-fixed-top" role="navigation">
	<div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="/" class="navbar-brand">
Traces of thought            </a>
        </div>
        <div class="collapse navbar-collapse navbar-ex1-collapse">
            <ul class="nav navbar-nav">
                         <li><a href="/pages/about.html">
                             About
                          </a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
              <li><a href="/archives.html"><i class="fa fa-th-list"></i><span class="icon-label">Archives</span></a></li>
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
</div> <!-- /.navbar -->
<!-- Banner -->
<!-- End Banner -->
<div class="container">
    <div class="row">
        <div class="col-sm-9">

    <section id="content">
        <article>
            <header class="page-header">
                <h1>
                    <a href="/posts/2016/05/whole-cell-electrophysiology-analysis-with-python/"
                       rel="bookmark"
                       title="Permalink to Whole-cell electrophysiology analysis with python">
                        Whole-cell electrophysiology analysis with python
                    </a>
                </h1>
            </header>
            <div class="entry-content">
                <div class="panel">
                    <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2016-05-04T13:00:00-04:00"> Wed 04 May 2016</time>
    </span>



<span class="label label-default">Tags</span>
	<a href="/tag/tutorial/">tutorial</a>
        /
	<a href="/tag/python/">python</a>
        /
	<a href="/tag/neuroscience/">neuroscience</a>
    
</footer><!-- /.post-info -->                    </div>
                </div>
                <p>This notebook is to demonstrate how I have used <a href="http://neuralensemble.org/neo/">Neo</a> and <a href="http://bluebrain.github.io/eFEL/">EFEL</a> packages to visualize and analyze whole-cell electrophysiology data. This was one of the first scientific problems that showed me how python could speed up  my required analysis for my research project.</p>
<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">efel</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">neo</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">curve_fit</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</pre></div>


<h2>Representing experiment files in python</h2>
<p>First, I want to create a list of the the recording data files which are in a directory based on the experiment conducted.</p>
<div class="highlight"><pre><span></span><span class="n">recording_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;../data/iclamp/examples/*.abf&#39;</span><span class="p">)</span>
</pre></div>


<p><a href="http://neuralensemble.org/neo/">Neo</a> has many different IO classes for reading various electrophysiology data formats.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">read_recording</span><span class="p">(</span><span class="nb">file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide filename and converts recording from Axon&#39;s .abf</span>
<span class="sd">    fileformat into a neo object&quot;&quot;&quot;</span>
    <span class="n">reader</span> <span class="o">=</span> <span class="n">neo</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">AxonIO</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">cascade</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">block</span>

<span class="n">block</span> <span class="o">=</span> <span class="n">read_recording</span><span class="p">(</span><span class="n">recording_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">segments</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>25
</pre></div>


<p>In these experiments, each recording from a neuron is represented as a block with multiple segments. Each segment has a corresponding analogsignal which was recorded with a different stimulus intensity (100 pA current steps for 100 ms).</p>
<div class="highlight"><pre><span></span><span class="n">block</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span>Segment with 1 analogs, 1 event arrays
# Analog signals (N=1)
0: AnalogSignal in 1.0 mV with 12500 float32 values
   name: &#39;IN 1&#39;
   channel index: 1
   sampling rate: 50000.0 Hz
   time: 0.0 s to 0.25 s
</pre></div>


<h2>Visualizing intracellular recordings</h2>
<p>In order to visualize a complete single neuron recording, I overlay each recorded analogsignal on the same temporal axis.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_block</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;plots all traces/analogsignals from a single recording/block&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">segments</span><span class="p">[::</span><span class="n">step</span><span class="p">]:</span>
        <span class="n">timecourse</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">times</span> <span class="o">-</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t_start</span>
        <span class="n">timecourse</span> <span class="o">=</span> <span class="n">timecourse</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timecourse</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (ms)&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;mV&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timecourse</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">plot_block</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_11_0.png" /></p>
<p>It's hard to distinguish each individual trace if I plot them on top of each other, so I can plot a single trace or a matrix like series of all the traces to visualize them all together at once.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_trace</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">features</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;plots a single trace (segment.analogsignal)&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
    <span class="n">timecourse</span> <span class="o">=</span> <span class="n">segment</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">times</span> <span class="o">-</span> <span class="n">segment</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t_start</span>
    <span class="n">timecourse</span> <span class="o">=</span> <span class="n">timecourse</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (ms)&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;mV&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timecourse</span><span class="p">,</span> <span class="n">segment</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="c1">#ax.plot</span>
    <span class="k">return</span> <span class="n">ax</span>

<span class="n">plot_trace</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">segments</span><span class="p">[</span><span class="mi">12</span><span class="p">])</span>
</pre></div>


<div class="highlight"><pre><span></span>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fccaa325a50&gt;
</pre></div>


<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_13_1.png" /></p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_recordings</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>
    <span class="n">stimulus_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1150</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">plot_num</span><span class="p">,</span> <span class="n">seg</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">segments</span><span class="p">):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">plot_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">timecourse</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">times</span> <span class="o">-</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t_start</span>
        <span class="n">timecourse</span> <span class="o">=</span> <span class="n">timecourse</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timecourse</span><span class="p">,</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;{} pA current step&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stimulus_range</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">plot_num</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;mV&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">plot_num</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">plot_num</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (ms)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

<span class="n">plot_recordings</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_14_0.png" /></p>
<h2>Extracting spike features</h2>
<p>To analyze these recordings I use a library called the <a href="http://bluebrain.github.io/eFEL/">Electrophys Feature Extraction Library (eFEL)</a>. This package allows me to extract specific features of from experimental or model generated recordings.</p>
<p>In this example I will identify each spike that occurs within the stimulus period and plot a marker on the peak of the spike.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_efel_traces</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;takes a block and returns a list of trace dicts which contain necessary information for efel feature</span>
<span class="sd">       extraction (time, voltage, stim_start and stim_end)&quot;&quot;&quot;</span>
    <span class="n">efel_traces</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">seg</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
        <span class="n">time</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">times</span><span class="o">-</span><span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t_start</span>
        <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">voltage</span><span class="o">=</span><span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">stim_start</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">stim_end</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="n">efel_traces</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">voltage</span><span class="p">,</span> <span class="s1">&#39;stim_start&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">stim_start</span><span class="p">],</span> <span class="s1">&#39;stim_end&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">stim_end</span><span class="p">]})</span>
    <span class="k">return</span> <span class="n">efel_traces</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_spike_features</span><span class="p">(</span><span class="n">block</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;takes a recording block and returns a list of dicts (one for each segment)</span>
<span class="sd">    with extracted features for each segment&quot;&quot;&quot;</span>
    <span class="n">traces</span> <span class="o">=</span> <span class="n">build_efel_traces</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">efel</span><span class="o">.</span><span class="n">getFeatureValues</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;Spikecount&#39;</span><span class="p">,</span><span class="s1">&#39;peak_time&#39;</span><span class="p">,</span> <span class="s1">&#39;peak_voltage&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">features</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">features</span> <span class="o">=</span> <span class="n">get_spike_features</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
</pre></div>


<p>The features list contains dicts with the extracted features for each segment. For example, the last segment here had 3 spikes.</p>
<div class="highlight"><pre><span></span><span class="n">features</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span>
</pre></div>


<div class="highlight"><pre><span></span>{&#39;Spikecount&#39;: array([2]),
 &#39;peak_time&#39;: array([ 4.9,  8. ]),
 &#39;peak_voltage&#39;: array([ 31.7993145, -12.2070303])}
</pre></div>


<p>Now I can create a plot_spikes() function by modifying the plot_recordings function to take in the features list.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_spikes</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The features list should contain the peak times and peak voltages of each extracted spike and will</span>
<span class="sd">       plot markers at spike peak time for those counted in addition to all traces/analogsignals</span>
<span class="sd">       from a single recording/block.&quot;&quot;&quot;</span>

    <span class="n">stimulus_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1150</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

    <span class="n">traces</span> <span class="o">=</span> <span class="n">build_efel_traces</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">plot_num</span><span class="p">,</span> <span class="p">(</span><span class="n">seg</span><span class="p">,</span> <span class="n">feats</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">segments</span><span class="p">,</span> <span class="n">features</span><span class="p">)):</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">plot_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">timecourse</span> <span class="o">=</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">times</span> <span class="o">-</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">t_start</span>
        <span class="n">timecourse</span> <span class="o">=</span> <span class="n">timecourse</span><span class="o">.</span><span class="n">rescale</span><span class="p">(</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">timecourse</span><span class="p">[:</span><span class="mi">7500</span><span class="p">],</span> <span class="n">seg</span><span class="o">.</span><span class="n">analogsignals</span><span class="p">[</span><span class="mi">0</span><span class="p">][:</span><span class="mi">7500</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;{} pA current step&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stimulus_range</span><span class="p">[</span><span class="n">plot_num</span><span class="p">]))</span>

        <span class="n">peak_time</span><span class="p">,</span> <span class="n">peak_voltage</span> <span class="o">=</span> <span class="n">feats</span><span class="p">[</span><span class="s1">&#39;peak_time&#39;</span><span class="p">],</span> <span class="n">feats</span><span class="p">[</span><span class="s1">&#39;peak_voltage&#39;</span><span class="p">]</span>
            <span class="c1">#peak time is in seconds, divide by 1000 so its in ms</span>
        <span class="k">if</span> <span class="n">feats</span><span class="p">[</span><span class="s1">&#39;peak_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">feats</span><span class="p">[</span><span class="s1">&#39;peak_voltage&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">peak_time</span><span class="p">,</span> <span class="n">peak_voltage</span><span class="p">,</span> <span class="s1">&#39;o&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_num</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;mV&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">plot_num</span> <span class="o">&lt;=</span> <span class="mi">4</span> <span class="ow">or</span> <span class="n">plot_num</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time (ms)&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">])</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">plot_spikes</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">features</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_23_0.png" /></p>
<h2>Processing a list of recordings</h2>
<p>Now that we can extract features from a recording and visualize them to make sure it's doing what we expect, we can put it in a function to extract all the features from a list of recordings.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process_recording_list</span><span class="p">(</span><span class="n">recording_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;takes a list of recordings names and returns a dictionary with</span>
<span class="sd">       filename as key and a list of spikenumbers as value&quot;&quot;&quot;</span>

    <span class="n">spike_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">recording</span> <span class="ow">in</span> <span class="n">recording_list</span><span class="p">:</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">read_recording</span><span class="p">(</span><span class="n">recording</span><span class="p">)</span>
        <span class="n">recording_features</span> <span class="o">=</span> <span class="n">get_spike_features</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>

        <span class="n">step_list</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">current_step</span> <span class="ow">in</span> <span class="n">recording_features</span><span class="p">:</span>
            <span class="n">step_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">current_step</span><span class="p">[</span><span class="s1">&#39;Spikecount&#39;</span><span class="p">]))</span>

        <span class="n">spike_dict</span><span class="p">[</span><span class="n">block</span><span class="o">.</span><span class="n">file_origin</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_list</span>

    <span class="k">return</span> <span class="n">spike_dict</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">spike_dict</span> <span class="o">=</span> <span class="n">process_recording_list</span><span class="p">(</span><span class="n">recording_list</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">stim_values</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1101</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">spike_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">stim_values</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">df</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>-100</th>
      <th>-50</th>
      <th>0</th>
      <th>50</th>
      <th>100</th>
      <th>150</th>
      <th>200</th>
      <th>250</th>
      <th>300</th>
      <th>350</th>
      <th>...</th>
      <th>650</th>
      <th>700</th>
      <th>750</th>
      <th>800</th>
      <th>850</th>
      <th>900</th>
      <th>950</th>
      <th>1000</th>
      <th>1050</th>
      <th>1100</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2013_02_15_0000.abf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>4</td>
      <td>...</td>
      <td>6</td>
      <td>5</td>
      <td>5</td>
      <td>6</td>
      <td>6</td>
      <td>5</td>
      <td>5</td>
      <td>5</td>
      <td>4</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2013_02_19_0043.abf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>3</td>
      <td>...</td>
      <td>4</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2013_03_06_0000.abf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>4</td>
      <td>5</td>
      <td>8</td>
      <td>7</td>
      <td>...</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2013_03_08_0005.abf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>3</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2013_04_10_0000.abf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>...</td>
      <td>2</td>
      <td>2</td>
      <td>3</td>
      <td>2</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2013_04_10_0003.abf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>...</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2013_04_10_0006.abf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>3</td>
      <td>4</td>
      <td>...</td>
      <td>8</td>
      <td>8</td>
      <td>7</td>
      <td>8</td>
      <td>7</td>
      <td>5</td>
      <td>6</td>
      <td>6</td>
      <td>7</td>
      <td>19</td>
    </tr>
    <tr>
      <th>2013_04_10_0014.abf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>2</td>
      <td>2</td>
      <td>3</td>
      <td>...</td>
      <td>4</td>
      <td>3</td>
      <td>3</td>
      <td>3</td>
      <td>2</td>
      <td>3</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2013_04_11_0000.abf</th>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>3</td>
      <td>3</td>
      <td>...</td>
      <td>3</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
      <td>2</td>
    </tr>
  </tbody>
</table>
<p>9 rows × 25 columns</p>
</div>

<h2>Fitting a sigmoid function to spike output data</h2>
<p>We want to fit a sigmoidal function to the output of each cell.</p>
<p>First define the function:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
     <span class="n">y</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">/</span><span class="n">k</span><span class="p">))</span>
     <span class="k">return</span> <span class="n">y</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_sig</span><span class="p">(</span><span class="n">dataseries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fits a sigmoid function to a series of data points.</span>
<span class="sd">       Returns a set of 3 parameters to define the function.&quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">dataseries</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="mi">2</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>

    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">,</span> <span class="n">dataseries</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dataseries</span><span class="p">,</span>
                           <span class="n">guess</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">2500</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">popt</span>
</pre></div>


<p>Then we want to see how that function represents our data so we plot it on top of the plot with spike number vs injected current:</p>
<div class="highlight"><pre><span></span><span class="n">dataseries</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;2013_03_06_0000.abf&#39;</span><span class="p">]</span>
<span class="n">single_cell_fit</span> <span class="o">=</span> <span class="n">fit_sig</span><span class="p">(</span><span class="n">dataseries</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">dataseries</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataseries</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>

<span class="n">y_fits</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">*</span><span class="n">single_cell_fit</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dataseries</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="n">dataseries</span><span class="p">[:</span><span class="mi">17</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_fits</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Current injected (pA)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of spikes&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Poor fit&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>&lt;matplotlib.text.Text at 0x7fcca9bd3610&gt;
</pre></div>


<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_35_1.png" /></p>
<p>This is an example of a poor fit, where the points with larger amount of current injected and small number of spikes are weighted too heavily. We are most interested in the activating function before the input/output levels are saturated, so we change the function as such:</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_sig</span><span class="p">(</span><span class="n">dataseries</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;fits a sigmoid function to a series of data points.</span>
<span class="sd">       Returns a set of 3 parameters to define the function.&quot;&quot;&quot;</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">dataseries</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="mi">2</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mi">400</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">guess</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="n">k</span><span class="p">)</span>

    <span class="c1">#the function is fit up to the point of max output level + 1 more step</span>
    <span class="n">y_max</span> <span class="o">=</span> <span class="n">dataseries</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">+</span><span class="mi">50</span>
    <span class="n">x_max</span>  <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataseries</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">y_max</span><span class="p">])</span>

    <span class="n">popt</span><span class="p">,</span> <span class="n">pcov</span> <span class="o">=</span> <span class="n">curve_fit</span><span class="p">(</span><span class="n">sigmoid</span><span class="p">,</span> <span class="n">dataseries</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="n">x_max</span><span class="p">],</span>
                           <span class="n">dataseries</span><span class="o">.</span><span class="n">loc</span><span class="p">[:</span><span class="n">y_max</span><span class="p">],</span> <span class="n">guess</span><span class="p">,</span> <span class="n">maxfev</span><span class="o">=</span><span class="mi">16000</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">popt</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">single_cell_fit</span> <span class="o">=</span> <span class="n">fit_sig</span><span class="p">(</span><span class="n">dataseries</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">dataseries</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">dataseries</span><span class="p">[:</span><span class="mi">17</span><span class="p">]</span>

<span class="n">y_fits</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="o">*</span><span class="n">single_cell_fit</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">dataseries</span><span class="o">.</span><span class="n">index</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="n">dataseries</span><span class="p">[:</span><span class="mi">17</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y_fits</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Current injected (pA)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of spikes&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Improved fit&#39;</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span>&lt;matplotlib.text.Text at 0x7fcca961ae10&gt;
</pre></div>


<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_39_1.png" /></p>
<p>As a sanity check, we can plot the fits for each of the neurons in the list of recordings.</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">()</span>
    <span class="n">fits</span> <span class="o">=</span> <span class="n">fit_sig</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">row</span>
    <span class="n">y_values</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">*</span><span class="n">fits</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="n">row</span><span class="p">[:</span><span class="mi">17</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">y_values</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Current injected (pA)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of spikes&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_41_0.png" /></p>
<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_41_1.png" /></p>
<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_41_2.png" /></p>
<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_41_3.png" /></p>
<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_41_4.png" /></p>
<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_41_5.png" /></p>
<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_41_6.png" /></p>
<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_41_7.png" /></p>
<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_41_8.png" /></p>
<p>Once we've determined that those fits are satisfactory, we can apply the fitting function to each recording in the dataframe and get a resulting dataframe of the fit values for each neuron.</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes a dataframe of spike counts per current step as parameter.</span>
<span class="sd">       Fits a sigmoidal function for each neuron recording and returns</span>
<span class="sd">       a dataframe with fit parameters for each neuron recording. &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">fit_values</span> <span class="o">=</span> <span class="n">fit_sig</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">frames</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">fit_values</span><span class="p">)]</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">frames</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">result</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">&#39;x0&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">&#39;k&#39;</span><span class="p">})</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">fits_df</span> <span class="o">=</span> <span class="n">fit_dataframe</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">fits_df</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>x0</th>
      <th>k</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2013_02_15_0000.abf</th>
      <td>5.702951</td>
      <td>304.418502</td>
      <td>64.675765</td>
    </tr>
    <tr>
      <th>2013_02_19_0043.abf</th>
      <td>4.307646</td>
      <td>291.948754</td>
      <td>82.887837</td>
    </tr>
    <tr>
      <th>2013_03_06_0000.abf</th>
      <td>7.720273</td>
      <td>207.414223</td>
      <td>39.948745</td>
    </tr>
    <tr>
      <th>2013_03_08_0005.abf</th>
      <td>2.173899</td>
      <td>304.535559</td>
      <td>125.139246</td>
    </tr>
    <tr>
      <th>2013_04_10_0000.abf</th>
      <td>2.273765</td>
      <td>288.213602</td>
      <td>109.743930</td>
    </tr>
    <tr>
      <th>2013_04_10_0003.abf</th>
      <td>2.583458</td>
      <td>231.417318</td>
      <td>93.624331</td>
    </tr>
    <tr>
      <th>2013_04_10_0006.abf</th>
      <td>8.240112</td>
      <td>351.781098</td>
      <td>81.572626</td>
    </tr>
    <tr>
      <th>2013_04_10_0014.abf</th>
      <td>4.465958</td>
      <td>310.926909</td>
      <td>97.424697</td>
    </tr>
    <tr>
      <th>2013_04_11_0000.abf</th>
      <td>3.814719</td>
      <td>270.552561</td>
      <td>67.999466</td>
    </tr>
  </tbody>
</table>
</div>

<h2>Final plot: putting it all together</h2>
<p>Requires:
- the average of the points at each current step
- the y std error
- the mean fit values</p>
<div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_data</span><span class="p">(</span><span class="n">analysis_df</span><span class="p">,</span> <span class="n">fit_df</span><span class="p">,</span> <span class="n">colour</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">a_mean</span> <span class="o">=</span> <span class="n">fit_df</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">x0_mean</span> <span class="o">=</span> <span class="n">fit_df</span><span class="o">.</span><span class="n">x0</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">k_mean</span> <span class="o">=</span> <span class="n">fit_df</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">popt</span> <span class="o">=</span> <span class="p">(</span><span class="n">a_mean</span><span class="p">,</span><span class="n">x0_mean</span><span class="p">,</span><span class="n">k_mean</span><span class="p">)</span>

    <span class="n">y_err</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">sem</span><span class="p">(</span><span class="n">analysis_df</span><span class="p">)</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span><span class="mi">700</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="o">*</span><span class="n">popt</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">analysis_df</span><span class="o">.</span><span class="n">columns</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="n">analysis_df</span><span class="o">.</span><span class="n">mean</span><span class="p">()[:</span><span class="mi">17</span><span class="p">],</span> <span class="n">yerr</span><span class="o">=</span><span class="n">y_err</span><span class="p">[:</span><span class="mi">17</span><span class="p">],</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">colour</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">150</span><span class="p">,</span> <span class="mi">750</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Current injected (pA)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Number of spikes&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">fits_df</span>
</pre></div>


<div>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>a</th>
      <th>x0</th>
      <th>k</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2013_02_15_0000.abf</th>
      <td>5.702951</td>
      <td>304.418502</td>
      <td>64.675765</td>
    </tr>
    <tr>
      <th>2013_02_19_0043.abf</th>
      <td>4.307646</td>
      <td>291.948754</td>
      <td>82.887837</td>
    </tr>
    <tr>
      <th>2013_03_06_0000.abf</th>
      <td>7.720273</td>
      <td>207.414223</td>
      <td>39.948745</td>
    </tr>
    <tr>
      <th>2013_03_08_0005.abf</th>
      <td>2.173899</td>
      <td>304.535559</td>
      <td>125.139246</td>
    </tr>
    <tr>
      <th>2013_04_10_0000.abf</th>
      <td>2.273765</td>
      <td>288.213602</td>
      <td>109.743930</td>
    </tr>
    <tr>
      <th>2013_04_10_0003.abf</th>
      <td>2.583458</td>
      <td>231.417318</td>
      <td>93.624331</td>
    </tr>
    <tr>
      <th>2013_04_10_0006.abf</th>
      <td>8.240112</td>
      <td>351.781098</td>
      <td>81.572626</td>
    </tr>
    <tr>
      <th>2013_04_10_0014.abf</th>
      <td>4.465958</td>
      <td>310.926909</td>
      <td>97.424697</td>
    </tr>
    <tr>
      <th>2013_04_11_0000.abf</th>
      <td>3.814719</td>
      <td>270.552561</td>
      <td>67.999466</td>
    </tr>
  </tbody>
</table>
</div>

<div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="kn">as</span> <span class="nn">sns</span>
</pre></div>


<div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_context</span><span class="p">(</span><span class="s1">&#39;paper&#39;</span><span class="p">,</span> <span class="n">font_scale</span><span class="o">=</span><span class="mf">1.75</span><span class="p">)</span>
<span class="n">plot_data</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">fits_df</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Example&#39;</span><span class="p">)</span>
</pre></div>


<p><img alt="png" src="/images/neuron_spikecount_files/neuron_spikecount_49_0.png" /></p>
            </div>
            <!-- /.entry-content -->
        </article>
    </section>

        </div>
        <div class="col-sm-3" id="sidebar">
            <aside>

<section class="well well-sm">
    <ul class="list-group list-group-flush">
            <li class="list-group-item"><h4><i class="fa fa-home fa-lg"></i><span class="icon-label">Social</span></h4>
              <ul class="list-group" id="social">
                <li class="list-group-item"><a href="https://github.com/derekhoward"><i class="fa fa-github-square fa-lg"></i> Github</a></li>
                <li class="list-group-item"><a href="https://twitter.com/internautderek"><i class="fa fa-twitter-square fa-lg"></i> Twitter</a></li>
              </ul>
            </li>



            <li class="list-group-item"><a href="/"><h4><i class="fa fa-tags fa-lg"></i><span class="icon-label">Tags</span></h4></a>
                <ul class="list-group " id="tags">
                </ul>
            </li>
    </ul>
</section>
            </aside>
        </div>
    </div>
</div>
<footer>
   <div class="container">
      <hr>
      <div class="row">
         <div class="col-xs-10">&copy; 2016 Derek Howard
            &middot; Powered by <a href="https://github.com/DandyDev/pelican-bootstrap3" target="_blank">pelican-bootstrap3</a>,
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a>,
            <a href="http://getbootstrap.com" target="_blank">Bootstrap</a>         </div>
         <div class="col-xs-2"><p class="pull-right"><i class="fa fa-arrow-up"></i> <a href="#">Back to top</a></p></div>
      </div>
   </div>
</footer>
<script src="/theme/js/jquery.min.js"></script>

<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="/theme/js/bootstrap.min.js"></script>

<!-- Enable responsive features in IE8 with Respond.js (https://github.com/scottjehl/Respond) -->
<script src="/theme/js/respond.min.js"></script>


</body>
</html>